<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.7 [en] (WinNT; I) [Netscape]">
   <title>TDS Protocol Documentation</title>
</head>

<body>
<H1>TDS Protocol Documentation</h1>
<P>
This document attempts to cover the TDS protocol for:
</P>

<table border=1>
	<tr><td align=center><b>TDS Version</b></td><td><b>Supported Products</b></td></tr>
	<tr><td align=center>4.2</td><td>Sybase SQL Server &lt; 10 and  Microsoft SQL Server 6.5</td></tr>
	<tr><td align=center>5.0</td><td>Sybase SQL Server &gt;= 10</td></tr>
	<tr><td align=center>7.0</td><td>Microsoft SQL Server 7.0</td></tr>
	<tr><td align=center>8.0</td><td>Microsoft SQL Server 2000</td></tr>
</table>
<p>
<b>Contents</b>
<br>
<ul>
<li><a href="#terms">Common Terms</a>
<li><a href="#examples">Typical Usage Sequences</a>
<li><a href="#packet">The Packet Format</a>
<li><a href="#login">Login Packet</a>
<li><a href="#login7">TDS 7.0 Login Packet</a>
<li><a href="#collate">Collate structure</a>
<li><a href="#requests">Client requests</a>
<li><a href="#responses">Server Responses</a>
</ul>

<p>
<a name="terms"></a>
<b class="section">Common Terms</b>
<pre>
TDS protocol versions
  TDS5    tds version 5.0
  TDS7    tds version 7.0
  TDS7+   tds version 7.0 and 8.0
  TDS5-   tds version 5.0 and previous

Variable types used in this document:
  CHAR      8-bit char
    CHAR[6]	string of 6 chars
    CHAR[n]     variable length string
  XCHAR    single byte (TDS5-) or ucs2le (TDS7+) characters
  INT8      8-bit int
  INT16    16-bit int
  INT32    32-bit int
  UCS2LE   Unicode in UCS2LE format
</pre>
Note:  FreeTDS uses TDS_TINYINT for INT8 and TDS_SMALLINT for INT16.

<p>
<a name="examples"></a>
<b class="section">Typical Usage sequences</b>
<br>
<br>
These are TDS 4.2 and not meant to be 100% correct, but
I thought they might be helpful to get an overall view 
of what goes on.
<pre>
--&gt; Login
&lt;-- Login acknowledgement

--&gt; INSERT SQL statement
&lt;-- Result Set Done

--&gt; SELECT SQL statement
&lt;-- Column Names
&lt;-- Column Info
&lt;-- Row Result
&lt;-- Row Result
&lt;-- Result Set Done

--&gt; call stored procedure
&lt;-- Column Names
&lt;-- Column Info
&lt;-- Row Result
&lt;-- Row Result
&lt;-- Done Inside Process
&lt;-- Column Names
&lt;-- Column Info
&lt;-- Row Result
&lt;-- Row Result
&lt;-- Done Inside Process
&lt;-- Return Status
&lt;-- Process Done
</pre>

<p>
<a name="packet"></a>
<b class="section">The packet format</b>
<br>
<br>
All packets start with the following 8 byte header.  

<pre>
 INT8       INT8          INT16      4 bytes
+----------+-------------+----------+--------------------+
|  packet  | last packet |  packet  |    unknown         |
|   type   |  indicator  |   size   |                    |
+----------+-------------+----------+--------------------+

Fields:
packet type 
     0x01 <a href="#p1">TDS 4.2 or 7.0 query</a>
     0x02 <a href="#login">TDS 4.2 or 5.0 login packet</a>
     0x03 <a href="#p3">RPC</a>
     0x04 <a href="#responses">responses from server</a>
     0x06 cancels
     0x07 Used in Bulk
     0x0F TDS 5.0 query
     0x10 <a href="#login7">TDS 7.0 login packet</a>
     0x11 <a href="#auth7">TDS 7.0 authentication packet</a>
     0x12 TDS 8 prelogin packet
last packet indicator 
     0x00 if more packets
     0x01 if last packet
packet size
     (in network byte order)
unknown?
     always 0x00
     this has something to do with server to server communication/rpc stuff
</pre>

The remainder of the packet depends on the type of information it is
providing.  As noted above, packets break down into the types query, login,
response, and cancels.  Response packets are further split into multiple
sub-types denoted by the first byte (a.k.a. the token) following the
above header.
<br>
<br>
<i>Note:</i>
  A TDS packet that is longer than 512 bytes is split on the 512 byte
  boundary and the "more packets" bit is set.  The full TDS packet is reassembled
  from its component 512 byte packets with the 8-byte headers stripped out.  (I
  believe the 512 is the block_size in the login packet, so it could be set to a
  different value. *mjs*)

<hr>
<p>
<a name="login"></a>
<b class="section">Login Packet</b>

<p>
Packet type (first byte) is 2. The numbers
on the left are decimal offsets <i>including</i> the 
8 byte packet header.
<pre>
byte   var type    description
------------------------------
   8   CHAR[30]    host_name
  38   INT8        host_name_length
  39   CHAR[30]    user_name
  69   INT8        user_name_length
  70   CHAR[30]    password
 100   INT8        password_length
 101   CHAR[30]    host_process
 131   INT8        host_process_length
 132   ?           magic1[6]          /* mystery stuff */
 138   INT8        bulk_copy 
 139   ?           magic2[9]          /* mystery stuff */
 148   CHAR[30]    app_name
 178   INT8        app_name_length
 179   CHAR[30]    server_name
 209   INT8        server_name_length
 210   ?           magic3[1]          /* 0, don't know this one either */
 211   INT8        password2_length
 212   CHAR[30]    password2
 242   CHAR[223]   magic4
 465   INT8        password2_length_plus2
 466   INT16       major_version      /* TDS version */
 468   INT16       minor_version      /* TDS version */
 470   CHAR        library_name[10]   /* "Ct-Library" or "DB-Library" */
 480   INT8        library_length
 481   INT16       major_version2     /* program version */
 483   INT16       minor_version2     /* program version */
 485   ?           magic6[3]          /* ? last two octets are 13 and 17 */
                                      /* bdw reports last two as 12 and 16 here  */
                                      /* possibly a bitset flag  */
 488   CHAR[30]    language           /* e.g. "us-english" */
 518   INT8        language_length
 519   ?           magic7[1]          /*  mystery stuff */
 520   INT16       old_secure         /* explanation? */
 522   INT8        encrypted          /*  1 means encrypted all password fields blank */
 523   ?           magic8[1]          /*  no clue... zeros */
 524   CHAR        sec_spare[9]       /* explanation? */
 533   CHAR[30]    char_set           /* e.g. "iso_1" */
 563   INT8        char_set_length
 564   INT8        magic9[1]          /* 1 */ 
 565   CHAR[6]     block_size         /*  in text */
 571   INT8        block_size_length 
 572   ?           magic10[25]        /* lots of stuff here...no clue */
</pre>
Any help with the magic numbers would be most appreciated.

<br>
<hr>
<p>
<a name="login7"></a>
<b class="section">TDS7.0 Login Packet</b>
<pre>
byte  var type  description
---------------------------
  0   INT32	total packet size
  4   INT8[4]	TDS Version	0x00000070 for TDS7, 0x01000071 for TDS8
                0x02000972 for mssql 2005
  8   INT32	packet size (default 4096)
 12   INT8[4]	client program version
 16   INT32	PID of client
 20   INT32	connection id (usually 0)
 24   INT8	option flags 1
                0x80 enable warning messages if SET LANGUAGE issued
                0x40 change to initial database must succeed
                0x20 enable warning messages if USE &lt;database&gt; issued
 25   INT8	option flags 2
                0x80 enable domain login security
                0x02 client is an ODBC driver
                0x01 change to initial language must succeed
 26   INT8	sql type flags (0)
 27   INT8	reserved flags (must be 0)
 28   INT8[4]	time zone (0x88ffffff ???)
 32   INT8[4]	collation information
 36   INT16	position of client hostname (86)
 38   INT16	hostname lenght
 40   INT16	position of username
 42   INT16	username length
 44   INT16	position of password
 46   INT16	password length
 48   INT16	position of app name
 50   INT16	app name length
 52   INT16	position of server name
 54   INT16	server name length
 56   INT16	0
 58   INT16	0
 60   INT16	position of library name
 62   INT16	library name length
 64   INT16	position of language
 66   INT16	language name
                (for italian "Italiano" coded UCS2)
 68   INT16	position of database name
 70   INT16	database name length
 72   INT8[6]	MAC address of client
 78   INT16	position of auth portion
 80   INT16	NT authentication length
 82   INT16	next position (same of total packet size)
 84   INT16	0
 86   UCS2LE[n] hostname
      UCS2LE[n]	username
      UCS2LE[n]	encrypted password
      UCS2LE[n]	app name
      UCS2LE[n]	server name
      UCS2LE[n]	library name
      UCS2LE[n]	language name
      UCS2LE[n]	database name
      NT Authentication packet

NT Authentication packet
  0   CHAR[8]	authentication id "NTLMSSP\0"
  8   INT32     1  message type
 12   INT32	0xb201 flags
 16   INT16	domain length
 18   INT16     domain length
 20   INT32     domain offset
 24   INT16     hostname length
 26   INT16     hostname length
 28   INT32     hostname offset
 32   CHAR[n]   hostname
      CHAR[n]   domain
See documentation on Samba for detail (or search ntlm authentication for IIS)

For mssql 2005 before hostname (byte 86) you have
 86   INT16     next position
 88   INT16     0
 90   INT8[4]   0x00000000 ???
 94   UCS2LE[n] hostname
      ... (like above)
</pre>
<p>"current pos" is the starting byte address for a Unicode string within
the packet.  The length of that Unicode string immediately follows.  
That implies there are at least 2 more strings that could be defined.
(character set??)
</p>

<p>Password and user is not used is NT authentication is used (setted as empty).</p>

<p>If client use an authentication packet server reply with 
<a href="#t237">Authentication</a> token followed by a <a href="#auth7">Authentication packet</a>.</p>

<hr>
<p>
<a name="auth7"></a>
<b class="section">TDS7.0 Authentication Packet</b>
</p>

<pre>
 varies
+------+
| auth |
+------+

auth   authentication data
       for NTLM this message 3
</pre>

<p>This packet usually follow <a href="#t237">Authentication</a> token.</p>

<hr>
<p>
<a name="types"></a>
<b class="section">Types</b>
</p>
<table border="1">
<tr>
  <th>HEX</th><th>DEC</th><th>type</th><th>protocol</th><th>nullable</th><th>size</th><th>collate</th>
</tr>
<tr>
  <td>0x1F</td><td>31</td><td>SYBVOID</td><td>7+</td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x22</td><td>34</td><td>SYBIMAGE</td><td></td><td>yes</td><td>4</td><td></td>
</tr>
<tr>
  <td>0x23</td><td>35</td><td>SYBTEXT</td><td></td><td>yes</td><td>4</td><td>yes</td>
</tr>
<tr>
  <td>0x24</td><td>36</td><td>SYBUNIQUE</td><td>7+</td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x25</td><td>37</td><td>SYBVARBINARY</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x26</td><td>38</td><td>SYBINTN</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x27</td><td>39</td><td>SYBVARCHAR</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x2D</td><td>45</td><td>SYBBINARY</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x2F</td><td>47</td><td>SYBCHAR</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x30</td><td>48</td><td>SYBINT1</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x32</td><td>50</td><td>SYBBIT</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x34</td><td>52</td><td>SYBINT2</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x38</td><td>56</td><td>SYBINT4</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x3A</td><td>58</td><td>SYBDATETIME4</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x3B</td><td>59</td><td>SYBREAL</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x3C</td><td>60</td><td>SYBMONEY</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x3D</td><td>61</td><td>SYBDATETIME</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x3E</td><td>62</td><td>SYBFLT8</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x40</td><td>64</td><td>SYBSINT1</td><td>5</td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x41</td><td>65</td><td>SYBUINT2</td><td>5</td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x42</td><td>66</td><td>SYBUINT4</td><td>5</td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x43</td><td>67</td><td>SYBUINT8</td><td>5</td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x62</td><td>98</td><td>SYBVARIANT</td><td>7+</td><td>yes</td><td>4</td><td></td>
</tr>
<tr>
  <td>0x63</td><td>99</td><td>SYBNTEXT</td><td>7+</td><td>yes</td><td>4</td><td>yes</td>
</tr>
<tr>
  <td>0x67</td><td>103</td><td>SYBNVARCHAR</td><td>7+</td><td>yes</td><td>2</td><td>??</td>
</tr>
<tr>
  <td>0x68</td><td>104</td><td>SYBBITN</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x6A</td><td>106</td><td>SYBDECIMAL</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x6C</td><td>108</td><td>SYBNUMERIC</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x6D</td><td>109</td><td>SYBFLTN</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x6E</td><td>110</td><td>SYBMONEYN</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x6F</td><td>111</td><td>SYBDATETIMN</td><td></td><td>yes</td><td>1</td><td></td>
</tr>
<tr>
  <td>0x7A</td><td>122</td><td>SYBMONEY4</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0x7F</td><td>127</td><td>SYBINT8</td><td></td><td>no</td><td>0</td><td></td>
</tr>
<tr>
  <td>0xA5</td><td>165</td><td>XSYBVARBINARY</td><td>7+</td><td>yes</td><td>2</td><td></td>
</tr>
<tr>
  <td>0xA7</td><td>167</td><td>XSYBVARCHAR</td><td>7+</td><td>yes</td><td>2</td><td>yes</td>
</tr>
<tr>
  <td>0xAD</td><td>173</td><td>XSYBBINARY</td><td>7+</td><td>yes</td><td>2</td><td></td>
</tr>
<tr>
  <td>0xAF</td><td>175</td><td>XSYBCHAR</td><td>7+</td><td>yes</td><td>2</td><td>yes</td>
</tr>
<tr>
  <td>0xE1</td><td>225</td><td>SYBLONGBINARY</td><td>5</td><td>yes</td><td>4</td><td></td>
</tr>
<tr>
  <td>0xE7</td><td>231</td><td>XSYBNVARCHAR</td><td>7+</td><td>yes</td><td>2</td><td>yes</td>
</tr>
<tr>
  <td>0xEF</td><td>239</td><td>XSYBNCHAR</td><td>7+</td><td>yes</td><td>2</td><td>yes</td>
</tr>
</table>
<hr>
<p>
<a name="collate"></a>
<b class="section">Collate type - TDS8</b>
<p>Collate structure contain information on characters set encoding and compare
method.</p>
<pre>
 INT16      INT16    INT8
+----------+--------+------------+
| codepage | flags  | charset_id |
+----------+--------+------------+

codepage    windows codepage (see <a href="http://www.microsoft.com/globaldev/nlsweb/">http://www.microsoft.com/globaldev/nlsweb/</a>)
            also specified in lcid column of master..syslanguages
flags       sort flags
            0x100 binary compare
            0x080 width insensitive
            0x040 Katatype insensitive
            0x020 accent insensitive
            0x010 case insensitive
            If binary flag is specified other flags are not present
            Low nibble of flags is a charset specifier (like chinese dialect)
charset_id  charset id in master..syscharsets table or zero for no SQL collations
</pre>

<p>Collations names can be obtained from <code>select name from ::fn_helpcollations()</code>
query</p>

<hr>
<a name="colInfo">&nbsp;</a>
<b class="subsection">Column Informations</b>


<pre>
 INT8          XCHAR[n]       INT8    INT32   INT8
+-------------+--------------+-------+-------+---------+
| column name | column name  | flags |  user | column  |
|   length    |              |       |  type |  type   |
+-------------+--------------+-------+-------+---------+

 varies        INT8       INT8       INT16      XCHAR[n]     INT8     varies
+-------------+----------+----------+----------+------------+--------+--------+
| column size |precision |  scale   | t length | table name | locale | locale |
|             |          |          |          |            | length |  info  |
| (optional)  |(optional)|(optional)|(optional)| (optional) | (opt)  | (opt)  |
+-------------+----------+----------+----------+------------+--------+--------+

column name length 
column name        column name in result set, not necessarily db column name
flags              bit flags
                   0x1  hidden (TDS5)
                   0x2  key
                   0x10 writable
                   0x20 can be NULL
                   0x40 identity
user type          usertype column from syscolumns
<a href="#types">column type</a>        column type
column size        not present for fixed size columns
precision          present only for SYBDECIMAL and SYBNUMERIC
scale              present only for SYBDECIMAL and SYBNUMERIC
t length           present only for SYBTEXT and SYBIMAGE, length of table name
table name         present only for SYBTEXT and SYBIMAGE
locale length      length of locale info (in bytes)
                   only for TDS5 results (not for parameters)
locale info        unknown
                   only for TDS5 results (not for parameters)
</pre>

<hr>
<p>
<a name="requests"></a>
<b class="section">Client request</b>
<p>

Normal tokens (contained in packets 0xF)
<pre>
TODO
</pre>

Special packets
<pre>
0x1  1  <a href="#p1">Language</a>
0x3  3  <a href="#p3">RPC</a>      TDS4.6+
</pre>

<hr>
<a name="p1"><b class="section">Language packet (0x1 1)</b></a>
<p>
This sample packet contain just SQL commands. It's supported by all TDS version
(although TDS5 have others token with similar use)
<pre>
  XCHAR[n]
+---------+
| string  |
+---------+

string   SQL text
</pre>

<hr>
<a name="p3"><b class="section">RPC packet (0x3 3)</b></a>

<p> Do not confuse an RPC packet with an RPC token. The RPC packet is supported
by all version of TDS; the RPC token is supported only by TDS 5.0 (and has
different format). This is the oldest (and the only one in mssql) way to call
directly an RPC.  Sybase also documents it, but as 0xE.  

<pre>
  INT16         XCHAR[n]   INT16  
+-------------+----------+-------+----------+
| name length | rpc name | flags | params   |
+-------------+----------+-------+----------+

name length   length of RPC name in characters. 
              mssql2k+ support some core RPC using numbers
              If a number is used instead of name name length is marked as -1
              (null) and a INT16 is used for the name.
                0x1  1  sp_cursor
                0x2  2  sp_cursoropen
                0x3  3  sp_cursorprepare
                0x4  4  sp_cursorexecute
                0x5  5  sp_cursorprepexec
                0x6  6  sp_cursorunprepare
                0x7  7  sp_cursorfetch
                0x8  8  sp_cursoroption
                0x9  9  sp_cursorclose
                0xA  10 sp_executesql
                0xB  11 sp_prepare
                0xC  12 sp_execute ???
                0xD  13 sp_prepexec
                0xE  14 sp_prepexecrpc
                0xF  15 sp_unprepare
rpc name      name of RPC. 
flags         bit flags. 
               0x1 1 recompile procedure (TDS7+/TDS5)
               0x2 2 no metadata (TDS7+)
                     (I don't know meaning of "no metadata" -- freddy77)
params        parameters. See below
</pre>

Every parameter has the following structure

<pre>
+-----------+------+
| data info | data |
+-----------+------+
data info    data information. See below
data         data. See results for detail
</pre>

Data info structure
<pre>
  INT8          XCHAR[n]     INT8    INT32
+-------------+------------+-------+-----------------+
| name length | param name | flags | usertype (TDS5) |
+-------------+------------+-------+-----------------+
  INT8   varies  varies     INT8[5]      INT8
+------+-------+----------+------------+---------------+
| type | size  | optional | collate    | locale        |
|      | (opt) | (opt)    | info(TDS8) | length (TDS5) |
+------+-------+----------+------------+---------------+

name length   parameter name length (0 if unused)
param name    parameter name
flags         bit Name           Meaning
              0x1 TDS_RPC_OUTPUT output parameter
              0x2 TDS_RPC_NODEF  output parameter has no default value. 
                                 Valid only with TDS_RPC_OUTPUT.

usertype      usertype
type          param type
size          see <a href="#t129">Results</a>
optional      see <a href="#t129">Results</a>. Blobs DO NOT have 
              optional on input parameters (output blob parameters
              are not supported by any version of TDS).
collate info  only for type that want collate info and using TDS8
locale length locale information length. Usually 0 (if not locale
              information follow, the structure is unknown)
</pre>

<hr>
<p>
<a name="responses"></a>
<b class="section">Server Responses</b>
<p>
Responses from the server start with a single octet (token) identifying
its type. If variable length, they generally have the length as the second
and third bytes
<p>
Tokens encountered thus far:
<table border="1">
<tr>
 <th>HEX</th><th>DEC</th><th>name</th><th>note</th>
</tr>
<tr>
 <td>0x20</td><td>32</td><td><a href="#t32">Param Format 2</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x21</td><td>33</td><td><a href="#t33">Language</a></td><td>5.0 only, client-side</td>
</tr>
<tr>
 <td>0x22</td><td>34</td><td><a href="#t34">OrderBy 2</a></td><td>5.0 only??</td>
</tr>
<tr>
 <td>0x61</td><td>97</td><td><a href="#t97">Row Format 2</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x71</td><td>113</td><td><a href="#t113">"Logout"</a></td><td>5.0? ct_close(), client-side?</td>
</tr>
<tr>
 <td>0x79</td><td>121</td><td><a href="#t121">Return Status</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0x7C</td><td>124</td><td><a href="#t124">Process ID</a></td><td>4.2 only</td>
</tr>
<tr>
 <td>0x80</td><td>128</td><td><a href="#t128">Cursor Close</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x81</td><td>129</td><td><a href="#t129c">Cursor Delete</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x81</td><td>129</td><td><a href="#t129">7.0 Result</a></td><td>7.0 only</td>
</tr>
<tr>
 <td>0x82</td><td>130</td><td><a href="#t130">Cursor Fetch</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x83</td><td>131</td><td><a href="#t131">Cursor Info</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x84</td><td>132</td><td><a href="#t132">Cursor Open</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x86</td><td>134</td><td><a href="#t134">Cursor Declare</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0x88</td><td>136</td><td><a href="#t136">7.0 Compute Result</a></td><td>7.0 only</td>
</tr>
<tr>
 <td>0xA0</td><td>160</td><td><a href="#t160">Column Name</a></td><td>4.2 only</td>
</tr>
<tr>
 <td>0xA1</td><td>161</td><td><a href="#t161">Column Format</a></td><td>4.2 only</td>
</tr>
<tr>
 <td>0xA3</td><td>163</td><td><a href="#t163">Dynamic 2</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xA4</td><td>164</td><td><a href="#t164">Table names</a></td><td>name of tables in a FOR BROWSE select</td>
</tr>
<tr>
 <td>0xA5</td><td>165</td><td><a href="#t165">Column Info</a></td><td>column information in a FOR BROWSE select</td>
</tr>
<tr>
 <td>0xA6</td><td>166</td><td><a href="#t166">Option Cmd</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xA7</td><td>167</td><td><a href="#t167">Compute Names</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xA8</td><td>168</td><td><a href="#t168">Compute Result</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xA9</td><td>169</td><td><a href="#t169">Order By</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xAA</td><td>170</td><td><a href="#t170">Error Message</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xAB</td><td>171</td><td><a href="#t171">Info Message</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xAC</td><td>172</td><td><a href="#t172">Output Parameters</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xAD</td><td>173</td><td><a href="#t173">Login Acknowledgement</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xAE</td><td>174</td><td><a href="#t174">Control</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xD1</td><td>209</td><td><a href="#t209">Data --- Row Result</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xD3</td><td>211</td><td><a href="#t211">Data --- Compute Result</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xD7</td><td>215</td><td><a href="#t215">Params</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xE2</td><td>226</td><td><a href="#t226">Capability</a></td><td>5.0 only. Information on server</td>
</tr>
<tr>
 <td>0xE3</td><td>227</td><td><a href="#t227">Environment Change</a></td><td>(database change, packet size, etc...)</td>
</tr>
<tr>
 <td>0xE5</td><td>229</td><td><a href="#t229">Extended Error Message</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xE6</td><td>230</td><td><a href="#t230">DBRPC</a></td><td>5.0 only RPC calls</td>
</tr>
<tr>
 <td>0xE7</td><td>231</td><td><a href="#t231">Dynamic</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xEC</td><td>236</td><td><a href="#t236">Param Format</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xED</td><td>237</td><td><a href="#t237">Authentication</a></td><td>7.0 only</td>
</tr>
<tr>
 <td>0xEE</td><td>238</td><td><a href="#t238">Result Set</a></td><td>5.0 only</td>
</tr>
<tr>
 <td>0xFD</td><td>253</td><td><a href="#t253">Result Set Done</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xFE</td><td>254</td><td><a href="#t254">Process Done</a></td><td>&nbsp;</td>
</tr>
<tr>
 <td>0xFF</td><td>255</td><td><a href="#t255">Done inside Process</a></td><td>&nbsp;</td>
</tr>
</table>

<a name="t32">&nbsp;</a> <hr>
<b class="section">Param Format 2 - TDS5 (0x20 32)</b>

<p>TODO.

<a name="t33">&nbsp;</a> <hr>
<b class="section">Language - TDS5 (0x21 33)</b>

<pre>
 INT32    INT8     CHAR[n]
+--------+--------+-------+
| length | status | query |
+--------+--------+-------+

length  total token length
status  0 no args
        1 has args (followed by PARAMFMT/PARAMS)
query   query (total length - 1)
</pre>

<a name="t34">&nbsp;</a> <hr>
<b class="section">Order By 2 (0x22 34)</b>

<p>TODO.

<a name="t97">&nbsp;</a> <hr>
<b class="section">Row Format 2 - TDS5 (0x61 97)</b>

<p>TODO.

<a name="t113">&nbsp;</a> <hr>
<b class="section">"Logout" (0x71 113)</b>
<p>
No information. (1 byte, value=0 ?)

<a name="t121">&nbsp;</a> <hr>
<b class="subsection">Return Status (0x79 121)</b>

<pre>
 INT32
+---------------+
| Return status |
+---------------+
</pre>

The return value of a stored procedure.

<a name="t124">&nbsp;</a> <hr>
<b class="subsection">Process ID (0x7C 124)</b>

<pre>
 8 bytes
+----------------+
| process number |
+----------------+
</pre>
Presumably the process ID number for an executing stored procedure.
(I'm not sure how this would ever be used by a client.  *mjs*)

<a name="t128">&nbsp;</a> <hr>
<b class="subsection">Cursor Close - TDS5 (0x80 128)</b>

<p>TODO.

<a name="t129c">&nbsp;</a> <hr>
<b class="subsection">Cursor Delete - TDS5 (0x81 129)</b>

<p>TODO.

<a name="t129">&nbsp;</a> <hr>
<b class="subsection">Result - TDS7+ (0x81 129)</b>

<pre>
 INT16  
+----------+-------------+
| #columns | column_info | 
+----------+-------------+
</pre>

The TDS 7.0 column_info is formatted as follows for each column:

<pre>
 INT16      INT16   INT8   varies  varies     INT8[5]      INT8          UCS2LE[n]
+----------+-------+------+-------+----------+------------+-------------+---------+
| usertype | flags | type | size  | optional | collate    | name length | name    | 
|          |       |      | (opt) | (opt)    | info(TDS8) |             |         |
+----------+-------+------+-------+----------+------------+-------------+---------+

usertype	type modifier
flags		bit flags
		0x1  can be NULL
		0x8  can be written (it's not an expression)
		0x10 identity 
<a href="#types">type</a>		data type, values &gt;128 indicate a large type
size		none for fixed size types
		4 bytes for blob and text
		2 bytes for large types
		1 byte for all others
optional
                               INT8        INT8
                              +-----------+-------+
  numeric/decimal types:      | precision | scale |
                              +-----------+-------+

                               INT16               UCS2LE[n]
                              +-------------------+------------+
  blob/text types:            | table name length | table name |
                              +-------------------+------------+

  collate info are available only using TDS8 and for characters types (but not
  for old type like short VARCHAR, only 2byte length versions)
</pre>


<a name="t130">&nbsp;</a> <hr>
<b class="subsection">Cursor Fetch - TDS5 (0x82 130)</b>

<p>TODO.

<a name="t131">&nbsp;</a> <hr>
<b class="subsection">Cursor Info - TDS5 (0x83 131)</b>

<p>TODO.

<a name="t132">&nbsp;</a> <hr>
<b class="subsection">Cursor Open - TDS5 (0x84 132)</b>

<p>TODO.

<a name="t134">&nbsp;</a> <hr>
<b class="subsection">Cursor Declare - TDS5 (0x86 134)</b>

<p>TODO.

<a name="t136">&nbsp;</a> <hr>
<b class="subsection">Compute Result - TDS7+ (0x88 136)</b>

<p>TODO.

<a name="t160">&nbsp;</a> <hr>
<b class="subsection">Column Name (0xA0 160)</b>

<pre>
 INT16          INT8      CHAR[n]               INT8      CHAR[n] 
+--------------+---------+--------------+------+---------+--------------+
| total length | length1 | column1 name | .... | lengthN | columnN name |
+--------------+---------+--------------+------+---------+--------------+
</pre>

<p>This token is the first token that contain result informations. Is usually followed by <a href="#t161">Column Format</a> token (0xA1 161)</p>

<hr>
<a name="t161">&nbsp;</a>
<b class="subsection">Column Format (0xA1 161)</b>

<pre>
 INT16  
+--------------+-------------+
| total length | column_info | 
+--------------+-------------+
</pre>

<p>The number of columns is the same of previous <a href="#t160">Column Name</a> token.
<p>The TDS 4.2 column_info is formatted as follows for each column:

<pre>
 INT8[4]     INT8   varies  varies
+-----------+------+-------+----------+
| usertype/ | type | size  | optional |
|   flags   |      | (opt) | (opt)    |
+-----------+------+-------+----------+

usertype/flags for Sybase

   INT32
  +----------+
  | usertype |
  +----------+

usertype/flags for MSSQL

   INT16
  +----------+-------+
  | usertype | flags |
  +----------+-------+

usertype	type modifier
flags		bit flags (only MSSQL)
		0x1  can be NULL
		0x8  can be written (it's not an expression)
		0x10 identity 
<a href="#types">type</a>		data type
size		none for fixed size types
		4 bytes for blob and text
		1 byte for all others
                (TDS 4.2 do not support large types)
optional
                               INT8        INT8
                              +-----------+-------+
  numeric/decimal types:      | precision | scale |
  (supported??)               +-----------+-------+

                               INT16               CHAR[n]
                              +-------------------+------------+
  blob/text types:            | table name length | table name |
                              +-------------------+------------+
</pre>

<a name="t163">&nbsp;</a> <hr>
<b class="subsection">Dynamic 2 - TDS5 (0xA3 163)</b>

<p>TODO.

<a name="t166">&nbsp;</a> <hr>
<b class="subsection">Option Cmd - TDS5 (0xA6 166)</b>

<p>TODO.

<a name="t168">&nbsp;</a> <hr>
<b class="subsection">Compute Result (0xA8 168)</b>

<pre>
 INT16          INT16        INT8       varies        INT8      INT8[n]
+--------------+------------+----------+-------------+---------+-------+
| total length | compute id | #columns | column info | #bycols | bycol |
+--------------+------------+----------+-------------+---------+-------+
</pre>

<p>column info:</p>

<pre>
 INT8       INT8      INT32      INT8     varies  INT8            varies
+----------+---------+----------+--------+-------+---------------+-------------+
| operator | operand | usertype | column | size  | locale length | locale info |
|          |         |          |  type  | (opt) |  info (TDS5)  | (TDS5)      |
+----------+---------+----------+--------+-------+---------------+-------------+

operator      operator
              0x4b COUNT
              0x4c UNSIGNED? COUNT
              0x4d SUM
              0x4e UNSIGNED? SUM
              0x4f AVG
              0x50 UNSIGNED? AVG
              0x51 MIN
              0x52 MAX
              0x09 COUNT_BIG (mssql2k)
              0x30 STDEV (mssql2k)
              0x31 STDEVP (mssql2k)
              0x32 VAR (mssql2k)
              0x33 VARP (mssql2k)
              0x72 CHECKSUM_AGG (mssql2k)
operand       ???
usertype      usertype
<a href="#types">column type</a>   data type
size          data size
locale length length of locale informations
locale info   locale informations (unknown)
</pre>

<p>Each bycol information contains column info for a specific column.</p>
<p>TODO: optional possible?? collate infos ??</p>

<a name="t164">&nbsp;</a> <hr>
<b class="section">TabName (0xA4 164)</b>

<p>TDS4/5/7:</p>

<pre>
 INT16          INT16         XCHAR[n]
+--------------+-------------+------------+
| total length | name length | table name | ...
+--------------+-------------+------------+

name length   table name length
table name    table name
</pre>

<p>TDS8:</p>

<pre>
 INT16          varies
+--------------+-------------+
| total length | table names |
+--------------+-------------+

table name:
 INT8              INT16              XCHAR[n]
+-----------------+------------------+----------------+
| # of components | component length | component name |
+-----------------+------------------+----------------+

ie:
  name        -&gt; 01  04 00  ucs2le "name"
  db..name    -&gt; 03  02 00  ucs2le "db"  00 00  04 00  ucs2le "name"
  db.dbo.name -&gt; 03  02 00  ucs2le "db"  03 00  ucs2le "dbo"  04 00  ucs2le "name"
</pre>

<a name="t165">&nbsp;</a> <hr>
<b class="section">Column Info (0xA5 165)</b>

<pre>
 INT16          varies
+--------------+--------------+
| total length | column infos |
+--------------+--------------+
</pre>

<p>column info:</p>

<pre>
 INT8    INT8          INT8    INT8          XCHAR[n]
+-------+-------------+-------+-------------+-------------+
| index | table index | flags | name length | column name |
|       |             |       |  (opt)      |  (opt)      |
+-------+-------------+-------+-------------+-------------+

index        index in result format (1-based)
table index  index in previous TabName (1-based)
             0 means no table (ie computed)
flags        set of flags
             0x04 expression
             0x08 key
             0x10 hidden
             0x20 column name present
name length  length of following column
column name  real column name (result contain the label)
</pre>

<p>This token follow TabName token</p>

<a name="t167">&nbsp;</a>
<a name="t174">&nbsp;</a> <hr>
<b class="section">compute "control" ? (0xA7 167)</b>
<br>
<b class="section">"control" (0xAE 174)</b>
<p>

Miscellaneous note (from *bdw* ?) found with 0xAE: <br>
<pre>
  has one byte for each column, 
  comes between result(238) and first row(209),
  I believe computed column info is stored here, need to investigate
</pre>

<a name="t169">&nbsp;</a> <hr>
<b class="section">Order By (0xA9 169)</b>

<pre>
 INT16    variable (1 byte per col)
+--------+---------+
| length | orders  |
+--------+---------+

length		Length of packet(and number of cols)
orders          one byte per order by indicating the
                column # in the output matching the
                order from Column Info and Column Names
                and data in following Row Data items.
                A 0 indicates the column is not in the
                resulting rows.

an example:
select first_name, last_name, number from employee
order by salary, number
assuming the columns are returned in the order
queried:
first_name then last_name, then number. we would have:
----------------
|  2   | 0 | 3 |
----------------
where length = 2 then the orders evaluate:
0 for salary, meaning there is no salary data returned
3 for number, meaning the 3rd data item corresponding
to a column is the number
</pre>

<a name="t170">&nbsp;</a>
<a name="t171"></a>
<a name="t229"></a> <hr>
<b class="section">Error Message (0xAA 170)</b>
<br>
<b class="section">Non-error Message (0xAB 171)</b>
<br>
<b class="section">Extended Error Message (0xE5 229)</b>

<pre>
 INT16    4 bytes      INT8    INT8    
+--------+------------+-------+-------+
| length | msg number | state | level |
+--------+------------+-------+-------+

 INT16      CHAR[n]   INT8       CHAR[n]   INT8       CHAR[n]   INT16  
+----------+---------+----------+---------+----------+---------+-------+
| m length | message | s length | server  | p length | process | line# |
+----------+---------+----------+---------+----------+---------+-------+

length		Length of packet
msg number	SQL message number
state		?
level		An error if level &gt; 10, a message if level &lt;= 10
m length	Length of message
message		Text of error/message
s length	Length of server name
server		Name of "server" ?
p length	Length of process name
process name	Stored procedure name, if any
line#		Line number of input which generated the message
</pre>

<a name="t172">&nbsp;</a> <hr>
<b class="section">Output Parameters (0xAC 172)</b>
<p>
Output parameters of a stored procedure.
<pre>
 INT16    INT8       XCHAR[n]  INT8    INT32      INT8
+--------+----------+---------+-------+----------+----------+------+
| length | c length | colname | flags | usertype | datatype | .... | 
+--------+----------+---------+-------+----------+----------+------+

length		Length of packet
c length	Length of colname
colname		Name of column
flags		0x1 Nullable
usertype	cf. systypes table in database
<a href="#types">datatype</a>	Type of data returned

The trailing information depends on whether the datatype is
a fixed size datatype.
				 N bytes
				+---------+
  Datatype of fixed size N	| data    |
				+---------+

				 INT8          INT8            N bytes
				+-------------+---------------+--------+
  Otherwise			| column size | actual size N | data   |
				+-------------+---------------+--------+
</pre>

<a name="t173">&nbsp;</a> <hr>
<b class="section">Login Acknowledgement (0xAD 173)</b>

<pre>
 INT16    INT8    4 bytes   INT8       XCHAR[n] 4 bytes
+--------+-------+---------+----------+--------+----------+
| length |  ack  | version | t length |  text  | ser_ver  |
+--------+-------+---------+----------+--------+----------+

length		length of packet
ack		0x01 success	4.2
		0x05 success	5.0
		0x06 failure	5.0
version		TDS version 4 bytes:  major.minor.?.?
t length	length of text
text		server name (ie 'Microsoft SQL Server')
ser_ver		Server version
		(with strange encoding, differring from TDS version)
</pre>

<a name="t209">&nbsp;</a>
<a name="t211">&nbsp;</a> <hr>
<b class="section">Data - Row Result (0xD1 209)</b>
<br>
<b class="section">Data - Compute Result (0xD3 211)</b>

<pre>
 INT8       variable size
+----------+--------------------+
|  token   |   row data         |
+----------+--------------------+
</pre>
Row data starts with one byte (decimal 209), for variable length types,
a one byte length field precedes the data, for fixed length records just
the data appears.
<br><i>Note:</i> nullable integers and floats are variable length.
<p>
For example: sp_who
<p>
The first field is spid, a smallint
<br>
The second field is status a char(12), in our example "recv sleep  "
<p>
The row would look like this:
<pre>
  byte  0 is the token
  bytes 1-2 are a smallint in low-endian
  byte  3 is the length of the char field
  bytes 4-15 is the char field

byte  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15
hex  D1  01  00  0C  72  65  63  76  20  73  6C  65  65  70  20  20
    209   1   0  12   r   e   c   v ' '   s   l   e   e   p ' ' ' '
</pre>

<a name="t215">&nbsp;</a> <hr>
<b class="section">Params - TDS5 (0xD7 215)</b>
<br>
<br>
TODO.

<a name="t226">&nbsp;</a> <hr>
<b class="section">Capability - TDS5 (0xE2 226)</b>
<br>

<pre>
 INT16    variable
+--------+--------------+
| length | capabilities |
+--------+--------------+

length		Length of capability string
capabilities	Server capabilities?  Related to login magic?
</pre>

<a name="t227">&nbsp;</a> <hr>
<b class="section">Environment change (0xE3 227)</b>
<br>

<pre>
 INT16    INT8       INT8        CHAR[n]   INT8        CHAR[n] 
+--------+----------+-----------+---------+-----------+---------+
| length | env code | t1 length |  text1  | t2 length |  text2  |
+--------+----------+-----------+---------+-----------+---------+

env code	Code for what part of environment changed
	0x01  database context
	0x02  language
	0x03  character set
	0x04  packet size
	0x05  TDS7+ LCID
	0x06  TDS7+ ??? (sort method? sql server encoding?)
	0x07  Collation info
text1		Old value
text2		New value

text1 and text2 are text information (coded in ucs2 in TDS7+) except 
collation info that's a structure (see collation structure)
</pre>

<a name="t230">&nbsp;</a> <hr>
<b class="section">DBRPC - TDS5 (0xE6 230)</b>
<br>
<br>
TODO.

<a name="t231">&nbsp;</a> <hr>
<b class="section">Dynamic - TDS5 (0xE7 231)</b>
<br>
<br>
TODO.

<a name="t236">&nbsp;</a> <hr>
<b class="section">Param Format - TDS5 (0xEC 236)</b>
<pre>
 INT16     INT16        variable size
+---------+------------+-------------------+
| length  | number of  | parameter info    |
|         | parameters |                   |
+---------+------------+-------------------+

length            	length of message following this field
number of parameters	number of parameter formats following
list of formats		I (*bdw*) imagine it uses the column format structure.
</pre>

<a name="t238">&nbsp;</a> <hr>
<b class="section">Result Set - TDS5 (0xEE 238)</b>

<pre>
 INT16     INT16        variable size
+---------+------------+-----------------+
| length  | number of  | column info     |
|         | columns    |                 |
+---------+------------+-----------------+


Fields:
length             length of message following this field
number of columns  number of columns in the result set, this many column
                   information fields will follow.
column info        <a href="#colInfo">column info</a>
</pre>

<a name="t237">&nbsp;</a> <hr>
<b class="section">Authentication - TDS7 (0xED 237)</b>
<pre>
 INT16     varies
+---------+------+
| length  | auth |
+---------+------+

length   length of authentication data following this field
auth     authentication data
         for NTLM this is message 2
</pre>

<p>Client reply with <a href="#auth7">Authentication packet</a>.</p>

<a name="t238">&nbsp;</a> <hr>
<b class="section">Result Set - TDS5 (0xEE 238)</b>

<pre>
 INT16     INT16        variable size
+---------+------------+-----------------+
| length  | number of  | column info     |
|         | columns    |                 |
+---------+------------+-----------------+


Fields:
length             length of message following this field
number of columns  number of columns in the result set, this many column
                   information fields will follow.
column info        <a href="#colInfo">column info</a>
</pre>

<a name="t253">&nbsp;</a>
<a name="t254"></a>
<a name="t255"></a> <hr>
<b class="section">Result Set Done (0xFD 253)</b><br>
<b class="section">Process Done (0xFE 254)</b><br>
<b class="section">Done Inside Process (0xFF 255)</b><br>

<pre>
 INT16       INT16     INT32
+-----------+---------+-----------+
| bit flags | unknown | row count |
+-----------+---------+-----------+

Fields:
bit flags          0x01 more results
		   0x02 error (like invalid sql syntax)
		   0x10 row count is valid
		   0x20 cancelled
unknown            2,0  /* something to do with block size perhaps */
row count          number of rows affected / returned in the result set. 
		(FIXME check if "affected / returned" is correct)
</pre>

"Result Set Complete" is the end of a query that doesn't create a process
on the server.  I.e., it doesn't call a stored procedure.
<br>
<br>
"Process Done" is the end of a stored procedure
<br>
<br>
"Done In Process" means that a query internal to a stored procedure
has finished, but the stored procedure isn't done overall.
<br>
<br>


<hr>

<p>
<b class="section">Acknowledgements</b>
<br>
The following people have contributed to this document:
<p>
Brian Bruns (first draft, protocol discovery)
<br>
Brian Wheeler (protocol discovery)
<br>
Mark Schaal (second draft)
<br>
Frediano Ziglio
<p>
(short list)
</body>
</html>
